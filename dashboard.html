<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <link rel="stylesheet" href="/styles/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
</head>
<body>
    <div class="dashboard-box">
        <h1 id="welcome">Loading...</h1>
        <p>Device data from ThingsBoard:</p>
        <div class="data-container">
            <pre id="device-data">Loading device data...</pre>
        </div>
        
        <!-- Map Section -->
        <div class="map-container">
            <div class="map-header">Device Location</div>
            <div id="device-map"></div>
            <div class="location-info" id="location-info">Location data will appear here when available</div>
        </div>
        
        <div class="controls">
            <button id="refresh-btn">Refresh Data</button>
            <button id="logout-btn">Logout</button>
        </div>
        
        <div class="alarm-controls">
            <h3>Alarm Control</h3>
            <div class="alarm-status">
                <p>Status: <span id="alarm-status">Disarmed</span></p>
            </div>
            <div class="alarm-buttons">
                <button id="arm-btn" class="alarm-btn arm-btn">Arm</button>
                <button id="turnoff-btn" class="alarm-btn turnoff-btn" disabled>Turn Off</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        let userId = null;
        let refreshInterval = null;
        let map = null;
        let marker = null;

        // Initialize map
        function initMap() {
            map = L.map('device-map').setView([45.815376, 15.983528], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Update map with device location
        function updateMapLocation(deviceData) {
            if (!map) return;

            try {
                const lat = deviceData.latitude && deviceData.latitude[0] ? parseFloat(deviceData.latitude[0].value) : null;
                const lng = deviceData.longitude && deviceData.longitude[0] ? parseFloat(deviceData.longitude[0].value) : null;

                if (lat && lng) {
                    // Remove existing marker
                    if (marker) {
                        map.removeLayer(marker);
                    }

                    // Add new marker
                    marker = L.marker([lat, lng]).addTo(map);
                    
                    // Center map on the location
                    map.setView([lat, lng], 15);

                    // Update location info
                    const timestamp = deviceData.latitude[0].ts;
                    const lastUpdate = new Date(timestamp).toLocaleString();
                    document.getElementById('location-info').innerHTML = 
                        `Latitude: ${lat}, Longitude: ${lng}<br>Last updated: ${lastUpdate}`;
                } else {
                    document.getElementById('location-info').textContent = 'No location data available';
                }
            } catch (error) {
                console.log('Could not parse location data:', error);
                document.getElementById('location-info').textContent = 'Error parsing location data';
            }
        }

        // Get user ID from URL
        function getUserIdFromUrl() {
            const path = window.location.pathname;
            const match = path.match(/\/user\/(\d+)/);
            return match ? parseInt(match[1]) : null;
        }

        // Get user info and update welcome message
        async function loadUserInfo() {
            userId = getUserIdFromUrl();
            if (!userId) {
                window.location.href = '/';
                return;
            }

            try {
                const response = await fetch(`/api/user/${userId}/info`);
                const userInfo = await response.json();
                
                if (response.ok) {
                    document.getElementById('welcome').textContent = `Welcome, ${userInfo.username}!`;
                } else {
                    throw new Error('Failed to load user info');
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                document.getElementById('welcome').textContent = 'Welcome!';
            }
        }

        // Fetch device data from ThingsBoard
        async function fetchDeviceData() {
            if (!userId) return;

            try {
                document.getElementById('device-data').textContent = 'Loading...';
                
                // Try the JWT-authenticated endpoint first
                let response = await fetch(`/api/user/${userId}/device-data`);
                
                // If that fails, fall back to simple device token endpoint
                if (!response.ok) {
                    console.log('JWT endpoint failed, trying simple endpoint...');
                    response = await fetch(`/api/user/${userId}/device-data-simple`);
                }

                const data = await response.json();
                
                if (response.ok) {
                    // Display the raw JSON data
                    document.getElementById('device-data').textContent = JSON.stringify(data, null, 2);
                    
                    // Check alarm status from device data
                    checkAlarmStatus(data);
                    
                    // Update map with location data
                    updateMapLocation(data);
                } else {
                    throw new Error(data.error || 'Failed to fetch data');
                }
            } catch (error) {
                console.error('Error fetching device data:', error);
                document.getElementById('device-data').textContent = `Error: ${error.message}`;
            }
        }

        // Check alarm status and update UI accordingly
        function checkAlarmStatus(deviceData) {
            try {
                // Look for alarm-related telemetry data
                // Adjust these field names based on your actual ThingsBoard telemetry keys
                const alarmArmed = deviceData.alarm_armed && deviceData.alarm_armed[0]?.value;
                const alarmTriggered = deviceData.alarm_triggered && deviceData.alarm_triggered[0]?.value;
                
                const statusElement = document.getElementById('alarm-status');
                const armBtn = document.getElementById('arm-btn');
                const turnoffBtn = document.getElementById('turnoff-btn');
                
                if (alarmTriggered === true || alarmTriggered === 'true') {
                    // Alarm is triggered
                    statusElement.textContent = 'TRIGGERED';
                    statusElement.className = 'status-triggered';
                    armBtn.disabled = true;
                    turnoffBtn.disabled = false;
                } else if (alarmArmed === true || alarmArmed === 'true') {
                    // Alarm is armed but not triggered
                    statusElement.textContent = 'Armed';
                    statusElement.className = 'status-armed';
                    armBtn.disabled = true;
                    turnoffBtn.disabled = true;
                } else {
                    // Alarm is disarmed
                    statusElement.textContent = 'Disarmed';
                    statusElement.className = 'status-disarmed';
                    armBtn.disabled = false;
                    turnoffBtn.disabled = true;
                }
            } catch (error) {
                console.log('Could not parse alarm status from device data:', error);
            }
        }

        // Send command to ThingsBoard device
        async function sendDeviceCommand(command, params = {}) {
            if (!userId) return;

            try {
                const response = await fetch(`/api/user/${userId}/send-command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        command: command,
                        params: params
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    console.log('Command sent successfully:', result);
                    // Refresh data after sending command
                    setTimeout(fetchDeviceData, 1000);
                } else {
                    throw new Error(result.error || 'Failed to send command');
                }
            } catch (error) {
                console.error('Error sending device command:', error);
                alert(`Error: ${error.message}`);
            }
        }

        // Arm the alarm
        async function armAlarm() {
            const armBtn = document.getElementById('arm-btn');
            armBtn.disabled = true;
            armBtn.textContent = 'Arming...';
            
            try {
                await sendDeviceCommand('arm_alarm', { armed: true });
                document.getElementById('alarm-status').textContent = 'Armed';
                document.getElementById('alarm-status').className = 'status-armed';
            } catch (error) {
                armBtn.disabled = false;
                armBtn.textContent = 'Arm';
            }
        }

        // Turn off the alarm
        async function turnOffAlarm() {
            const turnoffBtn = document.getElementById('turnoff-btn');
            turnoffBtn.disabled = true;
            turnoffBtn.textContent = 'Turning Off...';
            
            try {
                await sendDeviceCommand('turn_off_alarm', { armed: false, triggered: false });
                document.getElementById('alarm-status').textContent = 'Disarmed';
                document.getElementById('alarm-status').className = 'status-disarmed';
                document.getElementById('arm-btn').disabled = false;
            } catch (error) {
                turnoffBtn.disabled = false;
                turnoffBtn.textContent = 'Turn Off';
            }
        }

        // Initialize the dashboard
        function init() {
            loadUserInfo();
            initMap();
            fetchDeviceData();
            
            // Set up automatic refresh every 10 seconds
            refreshInterval = setInterval(fetchDeviceData, 10000);
            
            // Set up event listeners
            document.getElementById('refresh-btn').addEventListener('click', fetchDeviceData);
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('arm-btn').addEventListener('click', armAlarm);
            document.getElementById('turnoff-btn').addEventListener('click', turnOffAlarm);
        }

        // Logout function
        function logout() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            window.location.href = '/';
        }

        // Start the dashboard when page loads
        init();
    </script>
</body>
</html>